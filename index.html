<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/lua.min.js"></script>

<script>
(() => {
  const floatingBtn = document.getElementById('floatingCopyBtn');
  const menuPopup = document.getElementById('menuPopup');
  const menuOverlay = document.getElementById('menuOverlay');
  const navToggle = document.getElementById('navToggle');
  const themeSelector = document.getElementById('themeSelector');

  let activeWrapper = null, activeCodeEl = null, overBtn = false;

  /* Helpers */
  function isMobile() {
    return window.innerWidth <= 1000 || ('ontouchstart' in window);
  }

  /* Mobile nav */
  function openMenu() {
    menuPopup.classList.add('open');
    menuOverlay.classList.add('active');
  }
  function closeMenu() {
    menuPopup.classList.remove('open');
    menuOverlay.classList.remove('active');
  }
  navToggle.addEventListener('click', openMenu);
  menuOverlay.addEventListener('click', closeMenu);

  function updateMenuLinks() {
    menuPopup.innerHTML = '';
    document.querySelectorAll('header.topbar nav.topbar-nav a').forEach(a => {
      const link = document.createElement('a');
      link.href = a.href;
      link.textContent = a.textContent;
      link.onclick = e => {
        e.preventDefault();
        closeMenu();
        a.click(); // trigger desktop logic
      };
      menuPopup.appendChild(link);
    });
  }

  /* Copy logic */
  floatingBtn.addEventListener('click', async () => {
    if (!activeCodeEl) return;
    try {
      await navigator.clipboard.writeText(activeCodeEl.textContent);
      floatingBtn.classList.add('copied');
      floatingBtn.textContent = 'Copied!';
      setTimeout(() => {
        floatingBtn.classList.remove('copied');
        floatingBtn.textContent = 'Copy';
      }, 1500);
    } catch {}
  });
  floatingBtn.addEventListener('mouseenter', () => overBtn = true);
  floatingBtn.addEventListener('mouseleave', () => overBtn = false);

  function setActive(wrapper, code) {
    activeWrapper = wrapper;
    activeCodeEl = code;
    floatingBtn.classList.add(isMobile() ? 'always-visible' : 'show');
    positionBtn();
  }

  function positionBtn() {
    if (!activeWrapper) return;

    const rect = activeWrapper.getBoundingClientRect();
    const btnRect = floatingBtn.getBoundingClientRect();
    const vw = window.innerWidth, vh = window.innerHeight;
    const topbarHeight = document.querySelector('header.topbar').offsetHeight;

    // If code block is out of view, hide button
    if (rect.bottom <= 0 || rect.top >= vh) {
      floatingBtn.classList.remove('show', 'always-visible');
      return;
    }

    // Calculate position
    const left = Math.min(rect.right, vw) - btnRect.width - 8;

    // Ensure it never clips into topbar
    const minTop = topbarHeight + 8;
    const desiredTop = Math.max(rect.top, minTop) + 8;

    floatingBtn.style.left = left + 'px';
    floatingBtn.style.top = desiredTop + 'px';
  }

  /* Markdown */
  function renderMarkdown(mdFile) {
    fetch(mdFile + '?cache=' + Date.now())
      .then(r => r.text())
      .then(md => {
        const container = document.getElementById('content');
        container.innerHTML = marked.parse(md);
        container.querySelectorAll('pre > code').forEach(code => {
          const pre = code.parentElement;
          const wrap = document.createElement('div');
          wrap.className = 'code-block-wrapper';
          pre.parentElement.insertBefore(wrap, pre);
          wrap.appendChild(pre);
          wrap.addEventListener('mouseenter', () => !isMobile() && setActive(wrap, code));
          wrap.addEventListener('mousemove', () => !isMobile() && setActive(wrap, code));
          wrap.addEventListener('mouseleave', () => { if (!isMobile() && !overBtn) floatingBtn.classList.remove('show'); });
          wrap.addEventListener('touchstart', () => setActive(wrap, code), {passive:true});
        });
        hljs.highlightAll();
        updateMenuLinks();
      });
  }

  /* Dark mode */
  function setMode(dark) {
    document.body.classList.toggle('dark-mode', dark);
    document.getElementById('modeToggle').textContent = dark ? 'Light Mode' : 'Dark Mode';
    localStorage.setItem('mode', dark ? 'dark' : 'light');
  }
  setMode(localStorage.getItem('mode') === 'dark');
  document.getElementById('modeToggle').addEventListener('click', () => 
    setMode(!document.body.classList.contains('dark-mode'))
  );

  /* Theme switching */
  function setTheme(themeId) {
    document.querySelectorAll('link[id^="hljs-"]').forEach(l => l.disabled = true);
    const theme = document.getElementById(themeId);
    if (theme) theme.disabled = false;
    localStorage.setItem('hljs-theme', themeId);
  }

  themeSelector.addEventListener('change', e => setTheme(e.target.value));

  // Restore saved theme
  const savedTheme = localStorage.getItem('hljs-theme') || 'hljs-atom-light';
  themeSelector.value = savedTheme;
  setTheme(savedTheme);

  /* Nav */
  document.getElementById('homeBtn').addEventListener('click', e => { 
    e.preventDefault(); 
    renderMarkdown('README.md'); 
  });
  document.querySelectorAll('.page-link').forEach(link => 
    link.addEventListener('click', e => { 
      e.preventDefault(); 
      renderMarkdown(link.dataset.md); 
    })
  );

  /* Events */
  window.addEventListener('scroll', positionBtn, {passive:true});
  window.addEventListener('resize', () => { positionBtn(); updateMenuLinks(); });

  /* Init */
  renderMarkdown('README.md');
})();
</script>
